<!DOCTYPE html>
<html>
<head>
    <title>üåà SPECTR SOCIAL</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f23;
            color: #e0e0ff;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 300px;
            background: #1a1a2e;
            border-right: 2px solid #2d2d4d;
            display: flex;
            flex-direction: column;
        }
        .user-panel {
            padding: 20px;
            background: #16213e;
            border-bottom: 2px solid #2d2d4d;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #00adb5;
        }
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #2d2d4d;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }
        .tab.active {
            background: #00adb5;
            color: white;
        }
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .contact-item, .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        .contact-item:hover, .chat-item:hover {
            background: #2d2d4d;
        }
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff00;
            margin-left: auto;
        }
        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            background: #1a1a2e;
            border-bottom: 2px solid #2d2d4d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #0f0f23;
        }
        .message {
            margin: 15px 0;
            max-width: 70%;
        }
        .message.my {
            margin-left: auto;
        }
        .message-content {
            background: #00adb5;
            color: white;
            padding: 12px 18px;
            border-radius: 18px;
            display: inline-block;
        }
        .message.other .message-content {
            background: #2d2d4d;
        }
        .message-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .message-sender {
            font-weight: bold;
            color: #00adb5;
        }
        .message-time {
            font-size: 12px;
            color: #888;
        }
        .input-area {
            padding: 20px;
            background: #1a1a2e;
            border-top: 2px solid #2d2d4d;
            display: flex;
            gap: 10px;
        }
        #messageInput {
            flex: 1;
            padding: 15px;
            background: #2d2d4d;
            border: 2px solid #3d3d5d;
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }
        .action-btn {
            padding: 15px;
            background: #00adb5;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            min-width: 400px;
            border: 2px solid #00adb5;
        }
        .modal input, .modal textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #2d2d4d;
            border: 1px solid #3d3d5d;
            color: white;
            border-radius: 5px;
        }
        .btn {
            padding: 10px 20px;
            background: #00adb5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-danger {
            background: #ff4757;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <div class="user-panel">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                    <div>
                        <h3 id="userName"></h3>
                        <small id="userEmail"></small>
                    </div>
                </div>
            </div>
            
            <div class="nav-tabs">
                <div class="tab active" onclick="showTab('contacts')">üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
                <div class="tab" onclick="showTab('chats')">üí¨ –ß–∞—Ç—ã</div>
                <div class="tab" onclick="showTab('groups')">üë• –ì—Ä—É–ø–ø—ã</div>
            </div>
            
            <div class="tab-content" id="contactsTab">
                <button class="btn" onclick="showAddContactModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
                <div id="contactsList"></div>
            </div>
            
            <div class="tab-content" id="chatsTab" style="display: none;">
                <button class="btn" onclick="showCreateChatModal()">+ –°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
                <div id="chatsList"></div>
            </div>
            
            <div class="tab-content" id="groupsTab" style="display: none;">
                <button class="btn" onclick="showCreateGroupModal()">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                <div id="groupsList"></div>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="main-area">
            <div class="chat-header">
                <div id="currentChatInfo">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h2>
                </div>
                <div>
                    <button class="btn" onclick="showInviteModal()">üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                    <button class="btn btn-danger" onclick="showReportModal()">üö® –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
                    <button class="btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages"></div>
            
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button class="action-btn" onclick="sendMessage()" disabled>üì§</button>
                <button class="action-btn" onclick="showUploadModal()">üìé</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
            <input type="email" id="contactEmail" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <button class="btn" onclick="addContact()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn btn-danger" onclick="hideModal('addContactModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <div id="createChatModal" class="modal">
        <div class="modal-content">
            <h3>–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h3>
            <input type="text" id="chatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞">
            <select id="chatType">
                <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
                <option value="group">–ì—Ä—É–ø–ø–∞</option>
                <option value="channel">–ö–∞–Ω–∞–ª</option>
            </select>
            <div id="contactSelect"></div>
            <button class="btn" onclick="createChat()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn btn-danger" onclick="hideModal('createChatModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h3>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <select id="reportTarget">
                <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ -->
            </select>
            <textarea id="reportReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã..." rows="4"></textarea>
            <button class="btn" onclick="sendReport()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
            <button class="btn btn-danger" onclick="hideModal('reportModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
            <input type="file" id="fileInput" accept="image/*,video/*">
            <button class="btn" onclick="uploadFile()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button class="btn btn-danger" onclick="hideModal('uploadModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let currentChat = null;
        let contacts = [];
        let chats = [];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        window.onload = async () => {
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const response = await fetch('/api/user');
            currentUser = await response.json();
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.avatar;
            
            // –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º socket
            socket.emit('identify', currentUser.id);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
            await loadContacts();
            await loadChats();
            
            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è
            socket.on('contact_request', (data) => {
                if (confirm(`${data.from.name} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã. –ü—Ä–∏–Ω—è—Ç—å?`)) {
                    acceptContactRequest(data.from.id);
                }
            });
            
            socket.on('chat_invite', (data) => {
                if (confirm(`${data.inviter.name} –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å –≤ —á–∞—Ç "${data.name}"`)) {
                    joinChat(data.chatId);
                }
            });
            
            socket.on('new_message', (message) => {
                if (currentChat && currentChat.id === message.chat_id) {
                    displayMessage(message);
                }
            });
            
            socket.on('user_online', (userId) => {
                updateOnlineStatus(userId, true);
            });
            
            socket.on('user_offline', (userId) => {
                updateOnlineStatus(userId, false);
            });
        };
        
        async function loadContacts() {
            const response = await fetch('/api/contacts');
            contacts = await response.json();
            renderContacts();
        }
        
        async function loadChats() {
            const response = await fetch('/api/chats');
            chats = await response.json();
            renderChats();
        }
        
        function renderContacts() {
            const container = document.getElementById('contactsList');
            container.innerHTML = contacts.map(contact => `
                <div class="contact-item" onclick="openChat('contact', ${contact.id})">
                    <img src="${contact.avatar}" class="contact-avatar" alt="${contact.name}">
                    <div>
                        <strong>${contact.name}</strong><br>
                        <small>${contact.email}</small>
                    </div>
                    <div class="online-dot" id="online-${contact.id}"></div>
                </div>
            `).join('');
        }
        
        function renderChats() {
            const container = document.getElementById('chatsList');
            container.innerHTML = chats.map(chat => `
                <div class="chat-item" onclick="openChat('chat', ${chat.id})">
                    <div>
                        <strong>${chat.name}</strong><br>
                        <small>${chat.type === 'private' ? 'üë§' : 'üë•'} ${chat.member_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</small>
                    </div>
                </div>
            `).join('');
        }
        
        async function openChat(type, id) {
            if (type === 'contact') {
                // –°–æ–∑–¥–∞—ë–º –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
                const response = await fetch('/api/chats/private', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contactId: id })
                });
                currentChat = await response.json();
            } else {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
                currentChat = chats.find(c => c.id === id);
            }
            
            if (currentChat) {
                document.getElementById('currentChatInfo').innerHTML = `
                    <h2>${currentChat.name}</h2>
                    <small>${currentChat.type}</small>
                `;
                
                document.getElementById('messageInput').disabled = false;
                document.querySelector('button[onclick="sendMessage()"]').disabled = false;
                
                await loadChatMessages();
            }
        }
        
        async function loadChatMessages() {
            const response = await fetch(`/api/chats/${currentChat.id}/messages`);
            const messages = await response.json();
            
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            messages.forEach(msg => displayMessage(msg));
        }
        
        function displayMessage(msg) {
            const container = document.getElementById('chatMessages');
            const isMyMessage = msg.user_id === currentUser.id;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isMyMessage ? 'my' : 'other'}`;
            messageDiv.innerHTML = `
                <div class="message-info">
                    <span class="message-sender">${msg.name}</span>
                    <span class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                    ${msg.type === 'image' ? `<img src="${msg.file_url}" style="max-width: 300px; border-radius: 10px;">` : 
                      msg.type === 'video' ? `<video src="${msg.file_url}" controls style="max-width: 300px;"></video>` : 
                      msg.content}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content || !currentChat) return;
            
            socket.emit('send_message', {
                chatId: currentChat.id,
                userId: currentUser.id,
                content: content,
                type: 'text'
            });
            
            input.value = '';
        }
        
        async function addContact() {
            const email = document.getElementById('contactEmail').value;
            if (!email) return;
            
            await fetch('/api/contacts/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email })
            });
            
            hideModal('addContactModal');
            await loadContacts();
        }
        
        async function createChat() {
            const name = document.getElementById('chatName').value;
            const type = document.getElementById('chatType').value;
            const selectedContacts = Array.from(document.querySelectorAll('#contactSelect input:checked'))
                .map(cb => cb.value);
            
            if (!name || selectedContacts.length === 0) return;
            
            await fetch('/api/chats/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    name, 
                    type, 
                    members: selectedContacts 
                })
            });
            
            hideModal('createChatModal');
            await loadChats();
        }
        
        async function sendReport() {
            const targetId = document.getElementById('reportTarget').value;
            const reason = document.getElementById('reportReason').value;
            
            if (!targetId || !reason) return;
            
            await fetch('/api/report', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ targetId, reason })
            });
            
            hideModal('reportModal');
            alert('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success && currentChat) {
                socket.emit('send_message', {
                    chatId: currentChat.id,
                    userId: currentUser.id,
                    content: '',
                    type: result.type,
                    fileUrl: result.url
                });
            }
            
            hideModal('uploadModal');
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).style.display = 'block';
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function logout() {
            window.location.href = '/logout';
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        function showAddContactModal() {
            showModal('addContactModal');
        }
        
        function showCreateChatModal() {
            const container = document.getElementById('contactSelect');
            container.innerHTML = contacts.map(contact => `
                <label>
                    <input type="checkbox" value="${contact.id}">
                    ${contact.name} (${contact.email})
                </label><br>
            `).join('');
            showModal('createChatModal');
        }
        
        function showReportModal() {
            const select = document.getElementById('reportTarget');
            select.innerHTML = contacts.map(contact => 
                `<option value="${contact.id}">${contact.name} (${contact.email})</option>`
            ).join('');
            showModal('reportModal');
        }
        
        function showUploadModal() {
            showModal('uploadModal');
        }
    </script>
</body>
</html>
