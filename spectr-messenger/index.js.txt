// =========== ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ ===========
const express = require('express');
const app = express();
const server = require('http').createServer(app);
const io = require('socket.io')(server);
const multer = require('multer');
const nodemailer = require('nodemailer');

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²
const storage = multer.diskStorage({
  destination: 'uploads/',
  filename: (req, file, cb) => {
    cb(null, Date.now() + '-' + file.originalname);
  }
});
const upload = multer({ storage });

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ñ‡Ñ‚Ñ‹ (Ñ‚Ð²Ð¾Ñ Ð¿Ð¾Ñ‡Ñ‚Ð°!)
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: 'zenorvin@gmail.com', // Ð¢Ð’ÐžÐ¯ ÐŸÐžÐ§Ð¢Ð
    pass: 'Ñ‚Ð²Ð¾Ð¹-Ð¿Ð°Ñ€Ð¾Ð»ÑŒ-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ' // ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Gmail
  }
});

// =========== Ð‘ÐÐ—Ð Ð”ÐÐÐÐ«Ð¥ (ÐŸÐ ÐžÐ¡Ð¢ÐÐ¯) ===========
let users = {}; // {socketId: {name, avatar, contacts: []}}
let chats = {}; // {chatId: {type: 'private'/'group', members: [], messages: []}}
let reports = []; // Ð–Ð°Ð»Ð¾Ð±Ñ‹

// =========== Ð ÐžÐ£Ð¢Ð« ===========
app.use(express.static('public'));

// Ð“Ð»Ð°Ð²Ð½Ð°Ñ
app.get('/', (req, res) => {
  res.sendFile(__dirname + '/public/index.html');
});

// Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ñ‡Ð°Ñ‚Ð°
app.get('/chat/:id', (req, res) => {
  res.sendFile(__dirname + '/public/chat.html');
});

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð°
app.post('/upload', upload.single('file'), (req, res) => {
  if (req.file) {
    res.json({ 
      success: true, 
      url: '/uploads/' + req.file.filename,
      type: req.file.mimetype 
    });
  } else {
    res.json({ success: false });
  }
});

// ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¶Ð°Ð»Ð¾Ð±Ñ‹ Ð½Ð° Ð¿Ð¾Ñ‡Ñ‚Ñƒ
app.post('/report', express.json(), (req, res) => {
  const { reporter, reportedUser, reason } = req.body;
  
  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¶Ð°Ð»Ð¾Ð±Ñƒ
  reports.push({ reporter, reportedUser, reason, date: new Date() });
  
  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð° Ð¿Ð¾Ñ‡Ñ‚Ñƒ
  const mailOptions = {
    from: 'zenorvin@gmail.com',
    to: 'zenorvin@gmail.com', // Ð¢Ð’ÐžÐ¯ ÐŸÐžÐ§Ð¢Ð
    subject: 'ðŸš¨ Ð–ÐÐ›ÐžÐ‘Ð Ð’ Ð¡ÐŸÐ•ÐšÐ¢Ð ',
    text: `Ð–Ð°Ð»Ð¾Ð±Ð° Ð¾Ñ‚: ${reporter}\nÐÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${reportedUser}\nÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: ${reason}\nÐ”Ð°Ñ‚Ð°: ${new Date()}`
  };
  
  transporter.sendMail(mailOptions, (error) => {
    if (error) console.log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸:', error);
  });
  
  res.json({ success: true });
});

// =========== SOCKET.IO ===========
io.on('connection', (socket) => {
  console.log('ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ:', socket.id);
  
  // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  socket.on('register', (userData) => {
    users[socket.id] = {
      ...userData,
      contacts: [],
      createdAt: new Date()
    };
    
    // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð²ÑÐµÑ… Ð¾ Ð½Ð¾Ð²Ð¾Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ
    socket.broadcast.emit('user_online', userData.name);
  });
  
  // Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‡Ð°Ñ‚
  socket.on('create_chat', (data) => {
    const chatId = Date.now().toString();
    chats[chatId] = {
      type: data.type || 'private',
      name: data.name || 'ÐÐ¾Ð²Ñ‹Ð¹ Ñ‡Ð°Ñ‚',
      members: [socket.id, ...data.members],
      messages: [],
      admins: [socket.id],
      createdAt: new Date()
    };
    
    socket.emit('chat_created', { chatId, chat: chats[chatId] });
  });
  
  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
  socket.on('send_message', (data) => {
    const { chatId, text, fileUrl, fileType } = data;
    const user = users[socket.id];
    
    if (chats[chatId]) {
      const message = {
        id: Date.now(),
        sender: socket.id,
        senderName: user?.name || 'ÐÐ½Ð¾Ð½Ð¸Ð¼',
        text,
        fileUrl,
        fileType,
        timestamp: new Date()
      };
      
      chats[chatId].messages.push(message);
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ð¼ Ñ‡Ð°Ñ‚Ð°
      chats[chatId].members.forEach(memberId => {
        io.to(memberId).emit('new_message', { chatId, message });
      });
    }
  });
  
  // Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚
  socket.on('add_contact', (contactId) => {
    if (users[socket.id]) {
      users[socket.id].contacts.push(contactId);
      socket.emit('contact_added', contactId);
    }
  });
  
  // ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
  socket.on('disconnect', () => {
    const user = users[socket.id];
    if (user) {
      socket.broadcast.emit('user_offline', user.name);
      delete users[socket.id];
    }
  });
});

// =========== Ð—ÐÐŸÐ£Ð¡Ðš ===========
const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`ðŸŒˆ Ð¡ÐŸÐ•ÐšÐ¢Ð  Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸ‘‰ ÐžÑ‚ÐºÑ€Ð¾Ð¹: http://localhost:${PORT}`);
});